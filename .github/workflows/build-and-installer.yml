name: Build and Installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore PhotoshopPipelineApp/PhotoshopPipelineApp.csproj

      - name: Build
        run: dotnet build PhotoshopPipelineApp/PhotoshopPipelineApp.csproj -c Release --no-restore

      - name: Publish (self-contained win-x64)
        run: dotnet publish PhotoshopPipelineApp/PhotoshopPipelineApp.csproj -c Release --no-build -r win-x64 --self-contained true -p:PublishSingleFile=false -o publish

      - name: Create zip artifact
        run: |
          Compress-Archive -Path publish\* -DestinationPath PhotoshopPipelineApp-win-x64.zip

      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress

      - name: Build installer with Inno Setup
        id: installer
        continue-on-error: true
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (Test-Path $iscc) {
            & $iscc /DPublishDir="$PWD\publish" installer.iss
          }
          if (Test-Path "Output\PhotoshopPipelineApp-Setup.exe") {
            echo "has_installer=true" >> $env:GITHUB_OUTPUT
          }

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhotoshopPipelineApp-win-x64-zip
          path: PhotoshopPipelineApp-win-x64.zip

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        if: steps.installer.outputs.has_installer == 'true'
        with:
          name: PhotoshopPipelineApp-Setup
          path: Output/PhotoshopPipelineApp-Setup.exe
